{% comment %}
  Sección: Logos Infinitos / Estáticos
{% endcomment %}

{%- capture logos_json -%}
[
{%- assign first_item = true -%}
{%- for block in section.blocks -%}
  {%- if block.settings.logo != blank -%}
    {%- unless first_item -%},{%- endunless -%}
    {
      "url": {{ block.settings.logo | image_url: width: 400 | json }},
      "alt": {{ block.settings.logo_alt | default: 'Logo' | escape | json }},
      "link": {{ block.settings.logo_link | default: '' | json }}
    }
    {%- assign first_item = false -%}
  {%- endif -%}
{%- endfor -%}
]
{%- endcapture -%}

<style>
#shopify-section-{{ section.id }} {
  --carousel-speed: {{ section.settings.carousel_speed }}s;
}

#shopify-section-{{ section.id }} .logo-carousel-container {
  padding: {{ section.settings.section_padding_top }}px 0 {{ section.settings.section_padding_bottom }}px 0;
  background-color: {{ section.settings.background_color }};
  overflow: hidden;
}

/* TITULO */
#shopify-section-{{ section.id }} .section-title {
  text-align: center;
  font-weight: 700;
  margin-bottom: 40px;
  text-transform: uppercase;
}

/* CONTENEDOR */
#shopify-section-{{ section.id }} .marquee-container {
  max-width: {{ section.settings.max_width }}px;
  margin: 0 auto;
  overflow: hidden;
}

/* WRAPPER */
#shopify-section-{{ section.id }} .marquee-wrapper {
  display: flex;
  align-items: center;
  gap: {{ section.settings.logo_gap_desktop }}px;
}

/* SOLO SI ESTA ACTIVADO EL CARRUSEL */
{% if section.settings.enable_carousel %}
#shopify-section-{{ section.id }} .marquee-wrapper {
  width: max-content;
  animation: marquee var(--carousel-speed) linear infinite;
}
{% endif %}

@keyframes marquee {
  from { transform: translateX(0); }
  to { transform: translateX(-50%); }
}

/* MODO ESTATICO */
{% unless section.settings.enable_carousel %}
#shopify-section-{{ section.id }} .marquee-wrapper {
  flex-wrap: wrap;
  justify-content: center;
}
{% endunless %}

/* LOGOS */
#shopify-section-{{ section.id }} .marquee-wrapper img {
  width: {{ section.settings.logo_width_desktop }}px;
  max-width: {{ section.settings.logo_max_width_desktop }}px;
  height: auto;
  display: block;
  transition: 0.3s ease;
}

#shopify-section-{{ section.id }} .marquee-wrapper a,
#shopify-section-{{ section.id }} .marquee-wrapper span {
  display: flex;
  align-items: center;
  justify-content: center;
}
</style>

<div class="logo-carousel-container">

  {% if section.settings.show_title and section.settings.section_title != blank %}
    <h2 class="section-title">{{ section.settings.section_title }}</h2>
  {% endif %}

  <div class="marquee-container">
    <div class="marquee-wrapper" id="marquee-{{ section.id }}"></div>
  </div>

</div>

<script type="application/json" id="logos-data-{{ section.id }}">
{{ logos_json }}
</script>

<script>
(function(){
  function initLogos(sectionId) {
    const wrapper = document.getElementById('marquee-' + sectionId);
    const dataEl = document.getElementById('logos-data-' + sectionId);
    if (!wrapper || !dataEl) return;

    let logos = [];
    try {
      logos = JSON.parse(dataEl.textContent.trim() || '[]');
    } catch(e) {
      console.warn("JSON inválido");
      return;
    }

    wrapper.innerHTML = '';

    if (!Array.isArray(logos) || logos.length === 0) return;

    const repetitions = {{ section.settings.logo_repetitions | default: 16 }};
    const enableCarousel = {{ section.settings.enable_carousel | json }};

    const loopTimes = enableCarousel ? repetitions : 1;

    for (let i = 0; i < loopTimes; i++) {
      logos.forEach(logo => {
        const hasLink = logo.link && logo.link.trim() !== '';
        const container = hasLink ? document.createElement('a') : document.createElement('span');
        const img = document.createElement('img');

        if (hasLink) {
          container.href = logo.link;
          container.target = "_blank";
          container.rel = "noopener noreferrer";
        }

        img.src = logo.url;
        img.alt = logo.alt || "Logo";
        img.loading = "lazy";

        container.appendChild(img);
        wrapper.appendChild(container);
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    initLogos('{{ section.id }}');
  });

  document.addEventListener('shopify:section:load', function(e){
    if(e.detail.sectionId === '{{ section.id }}'){
      initLogos('{{ section.id }}');
    }
  });
})();
</script>

{% schema %}
{
  "name": "Logos Infinitos",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_carousel",
      "label": "Activar carrusel infinito",
      "default": true
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Título",
      "default": "Encuéntranos en"
    },
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Mostrar título",
      "default": true
    },
    {
      "type": "range",
      "id": "carousel_speed",
      "min": 10,
      "max": 200,
      "step": 10,
      "unit": "s",
      "label": "Velocidad",
      "default": 60
    },
    {
      "type": "range",
      "id": "logo_repetitions",
      "min": 5,
      "max": 30,
      "step": 1,
      "label": "Repeticiones",
      "default": 12
    },
    {
      "type": "range",
      "id": "logo_width_desktop",
      "min": 80,
      "max": 300,
      "step": 10,
      "unit": "px",
      "label": "Ancho logo",
      "default": 160
    },
    {
      "type": "range",
      "id": "logo_max_width_desktop",
      "min": 150,
      "max": 400,
      "step": 10,
      "unit": "px",
      "label": "Máx ancho logo",
      "default": 200
    },
    {
      "type": "range",
      "id": "logo_gap_desktop",
      "min": 20,
      "max": 150,
      "step": 10,
      "unit": "px",
      "label": "Espaciado logos",
      "default": 60
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Padding top",
      "default": 40
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Padding bottom",
      "default": 40
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 1200,
      "max": 2000,
      "step": 50,
      "unit": "px",
      "label": "Max width",
      "default": 1450
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Color fondo",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "logo",
      "name": "Logo",
      "settings": [
        { "type": "image_picker", "id": "logo", "label": "Imagen del logo" },
        { "type": "text", "id": "logo_alt", "label": "Alt" },
        { "type": "url", "id": "logo_link", "label": "Link opcional" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Logos Infinitos",
      "blocks": [
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" },
        { "type": "logo" }
      ]
    }
  ]
}
{% endschema %}
